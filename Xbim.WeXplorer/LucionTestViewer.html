<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Lucion Test Viewer</title>

    <script src="Libs/gl-matrix.js"></script>
    <script src="Libs/webgl-utils.js"></script>
    <script type="text/javascript" src="Viewer/xbim-product-type.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-state.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-shaders.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-model-geometry.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-model-handle.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-binary-reader.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-triangulated-shape.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-viewer.debug.js"></script>
    <script src="Libs/jquery.js"></script>

</head>
<body style="">
    <div id="info">
        <div >
             Building: <span id="Building"></span>
        </div>
        <div>
            Level: <span id="Level"></span>
        </div>
        <div>
            Location: <span id="Location"></span>
        </div>
        <div>
            Item: <span id="Item"></span>
        </div>
        <div>
            Material Description: <span id="Material Description"></span>
        </div>
        <div>
            Risk Level: <span id="Risk Level"></span>
        </div>
        <div> 
            Initial Control Recommendation: <span id="Initial Control Recommendation"></span>
        </div>
    </div>
    <canvas id="xBim-Viewer" width="750" height="450"></canvas>
    <script type="text/javascript">
        var viewer = new xViewer('xBim-Viewer');        

        //  Create .json
        var json = [];

        //  TODO Load CSVJSON with starting external then internal OR edit IntegrationSpace to create external items last. 
        var obj = $.getJSON("NexGenExample.json", function (data) {
            for (var i = 0; i < obj.responseJSON.length; i++) {
                json.push(obj.responseJSON[i]);
            }
        });        

        //  Array for Asbestos Samples in Building.
        var idReferences = [];

        //  Function created to retrieve relevant building elements in wexbim
        //  and append asbestos information.
        viewer.on('loaded', function () {

            //  Function created to retrieve an array of WexBIM Element ID's.
            var productIDs = viewer.getProductID(xProductType.IFCBUILDINGELEMENTPROXY);

            for (var i = 0; i < productIDs.length; i++) {
                var id = productIDs[i];

                //  Assumed that # of asi items in WexBim match # of NexGen CSV Items.
                var idReference = {
                    'id': id,                    
                    'Building': json[i]["Building"],
                    'Level': json[i]["Level"],
                    'Location': json[i]["Location"],
                    'Item': json[i]["Item Description"],
                    'Material Description': json[i]["Material Description"],
                    'Risk Level': json[i]["Risk Level"],
                    'Initial Control Recommendation': json[i]["Tentative Recommend"]
                    };

                idReferences.push(idReference);
            }
        });

        //  Uses search function to populate html with values in data []
        viewer.on('pick', function (args) {
            var id = args.id;

            //  Get HTML Elements
            var buildingHTML = document.getElementById('Building');
            var levelHTML = document.getElementById('Level');
            var locationHTML = document.getElementById('Location');
            var itemHTML = document.getElementById('Item');
            var materialDescriptionHTML = document.getElementById('Material Description');
            var riskLevelHTML = document.getElementById('Risk Level');
            var initialControlRecommendationHTML = document.getElementById('Initial Control Recommendation');

            //  Populate inner HTML
            levelHTML.innerHTML = search(id, idReferences, 'Level');
            locationHTML.innerHTML = search(id, idReferences, 'Location');
            itemHTML.innerHTML = search(id, idReferences, 'Item');
            materialDescriptionHTML.innerHTML = search(id, idReferences, 'Material Description');
            riskLevelHTML.innerHTML = search(id, idReferences, 'Risk Level');
            initialControlRecommendationHTML.innerHTML = search(id, idReferences, 'Initial Control Recommendation');
         });

        //  Function to retrieve data from array.
        function search(IDKey, myArray, sampleInfo) {
            for (var i = 0; i < myArray.length; i++) {
                if (myArray[i]['id'] == IDKey) {
                    return myArray[i][sampleInfo];
                }
            }
        }        

        viewer.load('tests/data/42 Floathaven Close.wexBIM');
        viewer.start();
    </script>

</body>
</html>