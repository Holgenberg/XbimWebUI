<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Lucion Test Viewer</title>

    <script src="Libs/gl-matrix.js"></script>
    <script src="Libs/webgl-utils.js"></script>
    <script type="text/javascript" src="Viewer/xbim-product-type.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-state.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-shaders.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-model-geometry.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-model-handle.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-binary-reader.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-triangulated-shape.debug.js"></script>
    <script type="text/javascript" src="Viewer/xbim-viewer.debug.js"></script>
    <script src="Libs/jquery.js"></script>

</head>
<body style="">
    <div id="info">
        <div >
             Building: <span id="Building"></span>
        </div>
        <div>
            Level: <span id="Level"></span>
        </div>
        <div>
            Location: <span id="Location"></span>
        </div>
        <div>
            Item: <span id="Item"></span>
        </div>
        <div>
            Material Description: <span id="Material Description"></span>
        </div>
        <div>
            Risk Level: <span id="Risk Level"></span>
        </div>
        <div> 
            Initial Control Recommendation: <span id="Initial Control Recommendation"></span>
        </div>
    </div>
    <canvas id="xBim-Viewer" width="750" height="450"></canvas>
    <script type="text/javascript">
        var viewer = new xViewer('xBim-Viewer');        

        var jobName = 'Vance Unit 2-3';

        //  Create .json
        var json = [];

        //  TODO Load CSVJSON with starting external then internal OR edit IntegrationSpace to create external items last. 
        $.getJSON("NexGenExample.json", function (data) {
            json = data["data"];
        });    

        //  Array for Asbestos Samples in Building.
        var idReferences = [];

        //  Function created to retrieve relevant building elements in wexbim
        //  and append asbestos information.
        viewer.on('loaded', function () {

            //  Function created to retrieve an array of WexBIM Element ID's.
            var productIDs = viewer.getProductID(xProductType.IFCBUILDINGELEMENTPROXY);

            for (var i = 0; i < productIDs.length; i++) {
                var id = productIDs[i];

                //  Assumed that # of asi items in WexBim match # of NexGen CSV Items.
                var idReference = {
                    'id': id,                    
                    'Building': json[i]["Building"],
                    'Level': json[i]["Level"],
                    'Location': json[i]["Location"],
                    'Item': json[i]["Item Description"],
                    'Material Description': json[i]["Material Description"],
                    'Risk Level': json[i]["Risk Level"],
                    'Initial Control Recommendation': json[i]["Tentative Recommend"]
                    };

                idReferences.push(idReference);

                //  NexGen Colour Scheme
                var riskLevel;

                switch (idReference["Risk Level"]) {
                    default:
                        riskLevel = [13, 77, 148, 255];
                        break;
                    case "NAD":
                        riskLevel = [0, 0, 0, 51];
                        break;
                    case "Presume":
                        riskLevel = [194, 112, 77, 255];
                        break;
                    case "Limited Access":
                        riskLevel = [161, 0, 180, 255];
                        break;
                    case "R3":
                        riskLevel = [250, 213, 0, 255];
                        break;
                    case "R2":
                        riskLevel = [255, 123, 0, 255];
                        break;
                    case "R1":
                        riskLevel = [255, 0, 0, 255];
                        break;
                }

                viewer.defineStyle(i, riskLevel);

                //  Fix colouring by Array
                viewer.setStyle(i, [id]);
            }
        });

        //  Uses search function to populate html with values in data []
        viewer.on('pick', function (args) {
            var id = args.id;

            //  Get HTML Elements
            var buildingHTML = document.getElementById('Building');
            var levelHTML = document.getElementById('Level');
            var locationHTML = document.getElementById('Location');
            var itemHTML = document.getElementById('Item');
            var materialDescriptionHTML = document.getElementById('Material Description');
            var riskLevelHTML = document.getElementById('Risk Level');
            var initialControlRecommendationHTML = document.getElementById('Initial Control Recommendation');

            //  Populate inner HTML
            buildingHTML.innerHTML = search(id, idReferences, 'Building');
            levelHTML.innerHTML = search(id, idReferences, 'Level');
            locationHTML.innerHTML = search(id, idReferences, 'Location');
            itemHTML.innerHTML = search(id, idReferences, 'Item');
            materialDescriptionHTML.innerHTML = search(id, idReferences, 'Material Description');
            riskLevelHTML.innerHTML = search(id, idReferences, 'Risk Level');
            initialControlRecommendationHTML.innerHTML = search(id, idReferences, 'Initial Control Recommendation');
         });

        //  Function to retrieve data from array.
        function search(IDKey, myArray, sampleInfo) {
            for (var i = 0; i < myArray.length; i++) {
                if (myArray[i]['id'] == IDKey) {
                    return myArray[i][sampleInfo];
                }
            }
        }        

        viewer.load('tests/data/' + jobName + '.wexBIM');
        viewer.start();
    </script>

</body>
</html>